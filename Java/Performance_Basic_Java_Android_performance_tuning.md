#Performance: Basic Java/Android performance tuning
#性能：初级Java/Android性能调优

<br/>
`Java` `Android` `Performance`
<br/>

##引子 
慢。应用中心APP的主界面打开太慢了，从点击图标到界面渲染完成需要20多秒，而且随着应用数据的增多，时间越来越长。实在是忍无可忍，我花了一天多时间优化了一下，把时间缩短到了2、3秒。本文是对这件事前后学习、思考的一个小结。<br/>
何为“初级”？我也期望搞一个大新闻，然而性能调优实在是个超级大的话题，目前搞个大新闻超出了我的能力。在这个“初级”短文里面，不涉及复杂的逻辑（很多思路是自然而然，水到渠成的），也不涉及高深的知识（JVM调优啥的没有）。目标和手段都很简单，将性能提高一点点，拿个60分。要拿90分？还是先把60分拿了。<br/>
基本的共识：持续优化。其实不仅仅是性能调优如此，凡是写代码都如此。昨天看到虎嗅上一篇文章[程序员，为什么千万不要重写代码？](http://www.huxiu.com/article/121139/1.html)，然后又想起之前看过图灵社区码农第7期的[PPP是什么？好玩的Python编程！](http://www.ituring.com.cn/article/61188)，这里顺便多吐槽几句：<br/>
>在我看来，合格的程序员都有“第二系统综合征”、“持续重写综合征”，一方面是读别人代码比自己写代码痛苦，一方面是有些代码的确写得很粗糙。但是，成熟的程序员会抑制重写的冲动，然后重构、优化。<br/>

##当我们在讨论性能时，我们在讨论什么？
性能给人的直观感觉就是快慢。通常我们会用到下面几个指标：<br/>
###响应时间
用户操作（请求）到数据呈现（响应）的时间间隔。这个时间间隔越短越好，用户感受最明显。<br/>
将时间分段，大概涉及IO、逻辑处理和展现三部分。<br/>
* IO时间：服务器端（数据库、磁盘、网络）、客户端（数据库、磁盘、网络）<br/>
* 逻辑处理时间：服务器端（算法）、客户端（web或者Android）<br/>
* 展现时间：客户端（数据处理与渲染）<br/>

###TPS
服务器每秒处理交易的次数，Transaction Per Second，反应了系统的吞吐量。这个值当然是越大越好。<br/>
这个指标与响应时间是相关的，通常一次交易的响应时间短，相应TPS会高一些。<br/>

###资源消耗
资源，包括内存、电量、网络流量等，消耗越少越好。大规模的集群，或者移动客户端比较敏感。<br/>

##性能优化的一般思路
正如引子里面说的，这里的观点是自然而然、水到渠成的，所以称为一般思路。<br/>
* 减少IO次数<br/>
	* 不执行IO<br/>
		* 缓存 1<br/>
		* 减少IO 2<br/>
	* 合并IO 3<br/>
* 减少IO内容<br/>
	* 精简协议 4<br/>
	* 压缩数据 5<br/>
* 多线程<br/>
* 同步转异步 6<br/>
* 提前或者延迟操作 7<br/>
* 其他<br/>
	* 减少不必要的sleep。<br/>
	* 减少不必要的异常处理。<br/>
	* 优化对性能瓶颈类的使用。8<br/>

<br/>
1：在本地/内存缓存静态数据，而不是每次都去服务器或者数据库取。软件系统随处都是缓存的身影：服务器缓存、客户端缓存、CDN。<br/>
2：例如，删除频繁的、无用的日志操作；调整日志级别。<br/>
3：将多个IO操作合并为一个IO操作，或者将多个类似的IO操作合并为一个批量操作。<br/>
4：使用更加高效的数据表达协议，例如，使用json，而不是xml。<br/>
5：例如，在HTTP协议中使用gzip，或者使用Base64而不是hex编码。<br/>
6：将同步处理转换为异步处理，前提是交易场景本身适用于异步操作。<br/>
7：将耗时较长的操作提前或者延迟处理。<br/>
8：例如，使用ThreadLocal保存SimpleDateFormat对象，而不是每次都创建。<br/>

##应用中心的改造
应用中心的代码写得太粗糙，所以才有20秒才渲染出主界面的故事可讲。可是正是如此，才给了我稍微一点点努力就到达60分的机会。<br/>
顺着一般思路，看看要怎么做：<br/>
###网络IO
在全工程搜索网络操作的代码。<br/>
1. 将每次打开主界面就去请求静态数据去掉，请求好了就放内存缓存起来。例如，供前台将权限英文翻译为中文的配置数据，几个月不见变动一次。<br/>
2. 将每次打开主界面就去请求分类信息、更新信息调整为最多10分钟一次。这样连续多次从onStop进入onRestart会非常流畅。<br/>
###数据库IO
在全工程搜索数据库操作代码。<br/>
1. 将循环列表逐个插入操作修改为批量操作，即由insert修改为bulkInsert。<br/>
2. 将频繁使用的静态数据缓存到内存，不再从数据库读取。<br/>
###磁盘IO
在全工程搜索磁盘IO操作代码，包括System.out和日志。<br/>
1. 去掉所有的System.out。<br/>
2. 去掉所有与System.out功能一致的调试日志。<br/>
3. 将生产版本的日志级别调整为Info。<br/>
###数据处理
1. 优化所有的json对象访问代码，减少判空操作，提高访问效率。<br/>

###其他
1. 减少sleep操作，或者减少sleep时间。<br/>
2. 去掉不必要的异常处理，特别是catch却不处理的。<br/>
3. 修改DateFormat的使用方式。<br/>

##小结
* 性能问题IO通常是大头，先把IO的问题解决。
* 写代码要字字珠玑，先动脑子后动手。
* 先拿60分，之后向90分努力。


##参考
[Trinea](http://www.trinea.cn/android/performance/)<br/>

<br/>
2015-7-25
